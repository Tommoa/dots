#!/bin/sh
# This file does some preprocessing for notmuch by putting some special tags
# in the correct maildir directories.

# The tag and folder that will be used for trash
trash=${TRASH:-'[Gmail]/Trash'}
trash_re=${TRASH_RE:-'\[Gmail\]/Trash'}

# The tag and folder that will be used for archiving
archive=${ARCHIVE:-'[Gmail]/All Mail'}
archive_re=${ARCHIVE_RE:-'\[Gmail\]/All Mail'}

# Fix up directories with tags before we sync
dir=$(notmuch config get database.path)
mbdir=${dir##*/}

# Move it to the trash if its deleted and not already there
notmuch search --output=files tag:deleted and not folder:"\"${trash}\"" \
    | grep -iv "${trash_re}" \
    | while IFS= read -r file;
do
    name="${file##*/}"
    # Get the IMAP flags
    flags="${name##*:}"
    directory=${file%%/${name}}
    # If its in the "new" directory, we need to set the flags ourselves
    if [ "${directory##*/}" = "new" ]; then flags="2,"; fi
    echo "Trashing ${file}"
    mv "${file}" "${dir}/${trash}/cur/$(uuidgen):${flags%%T}"
done

# Remove it from trash if its been undeleted and put it back in the archive
# This will be retagged below
notmuch search --output=files folder:"\"${trash}\"" and not tag:deleted \
    | while IFS= read -r file;
do
    name="${file##*/}"
    # Get the IMAP flags
    flags="${name##*:}"
    directory=${file%%/${name}}
    # If its in the "new" directory, we need to set the flags ourselves
    if [ "${directory##*/}" = "new" ]; then flags="2,"; fi
    echo "Untrashing ${file}"
    mv "${file}" "${dir}/${archive}/cur/$(uuidgen):${flags%%T}"
done

# If its not tagged inbox and is in an inbox, archive it
notmuch tag +archive -- folder:'"/(INBOX|.*@.*)/"' and not tag:inbox

# Archive things that are marked "archive"
notmuch search --output=messages tag:archive and folder:'"/(INBOX|.*@.*)/"' \
    | while IFS= read -r message;
do
    # There's two different scenarios in which we end up inside this loop:
    #  - The message has already been archived and we're looking at a copy
    #       (e.g. Gmail)
    #  - The message is only in our inbox and needs to be moved to the archive
    #       (e.g. normal mail)

    # The actual files associated with this message
    files="$(notmuch search --output=files ${message})"
    # The files already archived
    archived="$(echo ${files} | grep -i "${archive_re}")"
    # The files that aren't archived
    normal="$(echo ${files} | grep -iv "${archive_re}")"
    if [ -n "${archived}" ]; then
        # If the message has already been archived, then just delete it
        # to prevent duplication.
        echo "Already archived ${archived}"
        echo "${normal}" | xargs rm -f
    else
        # The message needs to be moved to the archive
        file="$(echo "${normal}" | head -n1)"
        echo "Archiving ${file}"
        name="${file##*/}"
        # Get the IMAP flags
        flags="${name##*:}"
        directory=${file%%/${name}}
        # If its in the "new" directory, we need to set the flags ourselves
        if [ "${directory##*/}" = "new" ]; then flags="2,"; fi
        mv "${file}" "${dir}/${archive}/cur/$(uuidgen):${flags%%T}"
        echo "${normal}" | xargs rm -f
    fi
done

# If its in All Mail and not in an inbox, tag it as archived
# One such reason why it might be this way is because of trash removal
notmuch tag +archive -inbox -- folder:"\"${archive}\"" \
    and not folder:'"/(INBOX|.*@.*)/"' \
    and not tag:archive

mbsync "${mbdir}"
